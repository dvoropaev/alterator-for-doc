<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Глава 4. Модули и backend-файлы</title>
</head>
<body>
  <nav><a href="index.html">На главную</a> · <a href="chapter03-manager-runtime.html">Предыдущая глава</a></nav>
  <h1>Глава 4. Модули и backend-файлы</h1>
  <p>Backend-файлы описывают интерфейсы D-Bus, а модули реализуют их поведение. Менеджер загружает backend-файлы из каталогов <code>/usr/share/alterator/backends</code> и <code>/etc/alterator/backends</code>, разбирает TOML и связывает методы с функциями модуля (<a href="../alterator-manager/docs/README-ru.md">docs/README-ru.md</a>).</p>
  <h2>Общие поля backend-файла</h2>
  <ul>
    <li><code>type = "Backend"</code> — фиксированное значение (<a href="../alterator-manager/docs/README-ru.md">README</a>).</li>
    <li><code>module</code> — имя модуля (например, <code>executor</code>).</li>
    <li><code>name</code> — узел дерева D-Bus; формирует часть пути объекта.</li>
    <li><code>interface</code> — имя интерфейса (короткое или полное <code>org.altlinux.alterator.*</code>).</li>
    <li><code>thread_limit</code> — допустимое число параллельных вызовов методов (<a href="../alterator-manager/docs/README-ru.md">README</a>).</li>
    <li><code>action_id</code> — идентификатор polkit (можно не задавать; тогда используется значение по умолчанию).</li>
  </ul>
  <p>Пример шаблона приведён в <a href="../alterator-test-services/test-service.backend.template">test-service.backend.template</a>.</p>
  <h2>Описание методов</h2>
  <p>Каждый метод описывается таблицей <code>[methods.&lt;Имя&gt;]</code>. Допустимые параметры определены модулем:</p>
  <ul>
    <li><code>execute</code> — обязательная команда или скрипт.</li>
    <li><code>stdin_string</code> — флаг передачи строки на stdin.</li>
    <li><code>stdout_strings</code>, <code>stdout_bytes</code>, <code>stdout_byte_arrays</code>, <code>stdout_string_array</code>, <code>stdout_json</code> — режимы чтения вывода (<a href="../alterator-manager/docs/README-ru.md">Раздел «executor»</a>).</li>
    <li><code>stderr_strings</code> — возврат stderr в виде массива строк.</li>
    <li><code>stdout_signal_name</code>, <code>stderr_signal_name</code> — имена сигналов, транслирующих вывод (<a href="../alterator-manager/docs/README-ru.md">README</a>).</li>
    <li><code>timeout</code> — ограничение времени выполнения в секундах.</li>
    <li><code>environment</code> — подтаблицы переменных окружения с полями <code>default</code> и <code>required</code>.</li>
  </ul>
  <p>Для методов executor действуют ограничения: разрешён один тип stdout-режима, приоритет — <code>stdout_strings</code> → <code>stdout_bytes</code> → <code>stdout_byte_arrays</code> → <code>stdout_string_array</code> → <code>stdout_json</code> (<a href="../alterator-manager/docs/README-ru.md">README</a>).</p>
  <h2>Модуль executor</h2>
  <p>Executor запускает внешние команды. Backend-файл для сервиса включает методы <code>Info</code>, <code>Deploy</code>, <code>Start</code>, <code>Stop</code>, <code>Configure</code>, <code>Status</code> и др. (<a href="../alterator-test-services/test-service.backend.template">шаблон</a>). В методах <code>Deploy</code> и <code>Undeploy</code> обычно включена передача stdin и сигналы для вывода.</p>
  <p>В исходнике <a href="../alterator-manager/docs/README-ru.md">README</a> описаны дополнительные параметры:</p>
  <ul>
    <li><code>stdout_byte_limit</code>, <code>stdout_strings_limit</code>, <code>stderr_strings_limit</code> — ограничения на размер выводимых массивов.</li>
    <li><code>stdout_json</code> — список ключей, извлекаемых из JSON-объекта stdout (возвращает несколько значений).</li>
    <li><code>environment.&lt;VAR&gt;.default</code> — значение по умолчанию, которое может быть переопределено через методы менеджера (<a href="../alterator-manager/docs/README-ru.md">Раздел «executor»</a>).</li>
  </ul>
  <h2>Модуль remote</h2>
  <p>Remote организует подключение к удалённому менеджеру через SSH. Описание методов (Connect, Disconnect и др.) находится в <a href="../alterator-manager/docs/README-ru.md">разделе «remote»</a>. Модуль не использует backend-файлы: он экспортирует интерфейс <code>org.altlinux.alterator.Remote</code> напрямую и взаимодействует с password agent.</p>
  <h2>Backend для диагностических интерфейсов</h2>
  <p>Диагностические инструменты оформляются отдельным backend-файлом (см. <a href="../alterator-test-services/test-service-diag.backend.template">test-service-diag.backend.template</a>). Интерфейс <code>diag1</code> предоставляет методы:</p>
  <ul>
    <li><code>Info</code> — отдаёт Entry-файл диагностики (<code>stdout_bytes</code>).</li>
    <li><code>Run</code> — запускает helper с параметрами и транслирует stdout/stderr через сигналы.</li>
    <li><code>List</code>, <code>Report</code> — возвращают список тестов или отчёт (строковый/байтовый вывод).</li>
  </ul>
  <p>Переменные окружения для списка тестов задаются через секцию <code>[methods.List.environment.*]</code> (<a href="../alterator-test-services/test-service-diag.backend.template">шаблон</a>).</p>
  <h2>Проверка соответствия интерфейсу</h2>
  <p>Менеджер сверяет backend с XML-описанием интерфейса в <code>/usr/share/dbus-1/interfaces</code>. Валидация не пройдёт, если отсутствуют методы, описанные в шаблоне, или сигнатуры не совпадают (<a href="../alterator-manager/docs/README-ru.md">Раздел «Валидация интерфейсов»</a>).</p>
  <h2>Пример: backend пакетов</h2>
  <p>Каталог <a href="../alterator-backend-packages/apt">alterator-backend-packages/apt</a> содержит backend <a href="../alterator-backend-packages/apt/apt.backend">apt.backend</a>, который использует executor для управления пакетами через <code>apt-get</code> и wrapper-скрипты. Методы включают <code>UpdateAsync</code>, <code>ApplyAsync</code>, <code>Search</code>, <code>DistUpgradeAsync</code>, возвращающие массивы строк и пересылающие stdout/stderr сигналами.</p>
  <h2>Практические шаги по созданию backend</h2>
  <ol>
    <li>Сформировать Entry-файл сервиса или диагностики (см. главу 2).</li>
    <li>Создать backend-файл с описанием интерфейса и методов. Проверить корректность имён и опций.</li>
    <li>Разместить файл в <code>/usr/share/alterator/backends</code> или <code>/etc/alterator/backends</code> в зависимости от режима.</li>
    <li>Перезапустить <code>alterator-manager</code> или дождаться автоматического перезапуска после изменения файлов.</li>
    <li>Проверить доступность методов через D-Bus (например, <code>gdbus call</code>) и убедиться, что сигналы зарегистрированы методом <code>GetSignals</code>.</li>
  </ol>
  <p>Следующая глава описывает полный жизненный цикл сервиса, включая helper-скрипты и интерфейс service1.</p>
</body>
</html>
