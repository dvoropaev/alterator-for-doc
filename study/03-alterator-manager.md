# Глава 3. alterator-manager
alterator-manager — системная служба, обеспечивающая доступ к backend-интерфейсам Alterator через D-Bus.

## Назначение демона
Возможности:
- Загружает `.backend` файлы из системных и пользовательских каталогов.
- Создаёт дерево объектов D-Bus и привязывает методы к выбранным модулям.
- Проводит валидацию интерфейсов по шаблонам `/usr/share/dbus-1/interfaces`.
- Управляет пулом потоков исполнения для методов backend.

## Каталоги и порядок загрузки
Порядок:
1. Режим system: `/usr/share/alterator/backends/`, `/usr/share/alterator/backends/system/`, `/etc/alterator/backends/`, `/etc/alterator/backends/system/`.
2. Режим user (`--user`): `/usr/share/alterator/backends/user/`, `/etc/alterator/backends/user/`.
3. При совпадении имён интерфейсов используется первое встретившееся определение; дубликаты игнорируются.

## Структура данных
Характеристики:
- `backends_data` — хеш-таблица с ключом `node_name` и значением набора интерфейсов.
- Для каждого интерфейса хранится `InterfaceObjectInfo`: `module_name`, `action_id`, `interface_introspection`, `methods`, `interface_vtable`, `thread_limit`.
- Методы описываются структурами `MethodObjectInfo`; каждая содержит `method_data` (ключи из `.backend`) и `environment` (переменные окружения).
- Параметры `thread_limit` и `action_id` берутся из корневой секции файла; при отсутствии задаются значения по умолчанию (10 потоков, action-id из имени интерфейса).

## Работа с методами
Особенности:
- Имена методов определяются в секции `[methods.<name>]`; допустимы латинские буквы, цифры и подчёркивание.
- Поля секции передаются модулю-исполнителю. Для модуля `executor` используется ключ `execute` со строкой команды.
- Внутри строки допускаются параметры `{param}`; значения подставляются из аргументов D-Bus метода.
- Переменные окружения настраиваются через секцию `[environment.<var>]` внутри метода.

## Валидация и безопасность
Важно:
- Шаблоны интроспекции в `.xml` сравниваются с определением интерфейса; отсутствие методов считается ошибкой проверки.
- Поле `action_id` задаёт идентификатор polkit; при пропуске формируется автоматически на основе имени интерфейса.
- Ограничение `thread_limit` защищает от перегрузки модуля и позволяет дозировать параллелизм.

## Отладка и инструменты
Рекомендации:
- Использовать утилиту из `alterator_manager_dev_tool` для диагностики загруженных интерфейсов.
- Проверять журналы systemd юнита `alterator-manager.service` для анализа ошибок загрузки.
- При разработке модулей хранить шаблоны интроспекции в `schemas/` и добавлять их в пакет.
