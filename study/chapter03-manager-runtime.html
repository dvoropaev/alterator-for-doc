<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Глава 3. Alterator Manager и цикл выполнения</title>
</head>
<body>
  <nav><a href="index.html">На главную</a> · <a href="chapter02-entry-model.html">Предыдущая глава</a></nav>
  <h1>Глава 3. Alterator Manager и цикл выполнения</h1>
  <p>Alterator Manager — системный демон, который читает backend-описания, публикует D-Bus-интерфейсы и маршрутизирует вызовы к модулям. Основные детали реализованы в исходниках каталога <a href="../alterator-manager">alterator-manager</a> и описаны в <a href="../alterator-manager/docs/README-ru.md">docs/README-ru.md</a>.</p>
  <h2>Запуск и инициализация</h2>
  <p>Менеджер стартует под управлением systemd-юнита <a href="../alterator-manager/alterator-manager.service">alterator-manager.service</a>. Точка входа в <a href="../alterator-manager/main.c">main.c</a> разбирает параметры командной строки (<code>--debug</code>, <code>--user</code>), включает журналирование и выполняет последовательность инициализации:</p>
  <ol>
    <li><strong>alterator_manager_backends_init()</strong> — загрузка backend-файлов из системных и пользовательских каталогов.</li>
    <li><strong>alterator_manager_polkit_init()</strong> — настройка проверки прав (пропускается в режиме <code>--user</code>).</li>
    <li><strong>alterator_manager_sender_environment_init()</strong> — подготовка таблицы переменных окружения для клиентов D-Bus.</li>
    <li><strong>alterator_manager_modules_init()</strong> — загрузка модулей из каталога <code>MODULES_DIR</code> через <a href="../alterator-manager/alterator_manager_modules.c">alterator_manager_modules.c</a>.</li>
    <li><strong>alterator_manager_default_interfaces_init()</strong> — регистрация корневого интерфейса <code>org.altlinux.alterator.manager</code>.</li>
    <li><strong>alterator_manager_backend_monitor_init()</strong> — запуск мониторинга файлов backend для перезапуска службы при изменениях.</li>
    <li><strong>alterator_manager_dbus_init()</strong> — публикация имени <code>org.altlinux.alterator</code> на шине.</li>
  </ol>
  <p>Главный цикл <code>GMainLoop</code> обрабатывает события D-Bus и таймеры: очистку окружения клиентов и проверку изменения файлов (<a href="../alterator-manager/main.c">main.c</a>).</p>
  <h2>Модель данных</h2>
  <p>Менеджер хранит информацию о backend-файлах в многоуровневой хеш-таблице <code>backends_data</code> (<a href="../alterator-manager/alterator_manager_backends.c">alterator_manager_backends.c</a>):</p>
  <ul>
    <li>Ключ верхнего уровня — <em>node_name</em>, соответствующий объекту D-Bus.</li>
    <li>Значение — таблица интерфейсов, где ключом является имя интерфейса, а значением — структура <code>InterfaceObjectInfo</code> с полями <code>module_name</code>, <code>action_id</code>, <code>interface_introspection</code>, <code>methods</code>, <code>thread_limit</code> (<a href="../alterator-manager/docs/README-ru.md">Раздел «Хранение данных»</a>).</li>
    <li>В структуре метода (<code>MethodObjectInfo</code>) содержится <code>method_data</code> (атрибуты из backend-файла) и <code>environment</code> (переменные окружения) (<a href="../alterator-manager/docs/README-ru.md">README</a>).</li>
  </ul>
  <p>Парсер backend-файлов проверяет корректность имён методов (<code>is_correct_name</code>) и action_id (<code>is_correct_action_id</code>), собирает массивы и окружение (<code>save_methods_arrays</code>, <code>save_methods_environment</code>) (<a href="../alterator-manager/alterator_manager_backends.c">alterator_manager_backends.c</a>).</p>
  <h2>Публикация интерфейсов</h2>
  <p>Корневой интерфейс <code>org.altlinux.alterator.manager</code> объявлен в <a href="../alterator-manager/alterator_manager_default_interfaces.c">alterator_manager_default_interfaces.c</a>. Он предоставляет методы:</p>
  <ul>
    <li><code>GetObjects(interface)</code> — список объектов, реализующих указанный интерфейс.</li>
    <li><code>GetAllObjects()</code>, <code>GetInterfaces(object)</code>, <code>GetAllInterfaces()</code> — навигация по дереву.</li>
    <li><code>GetSignals(object, interface, method)</code> — перечень сигнальных имён, объявленных в backend-файле для метода.</li>
    <li><code>GetEnvValue(name)</code>, <code>SetEnvValue(name, value)</code>, <code>UnsetEnvValue(name)</code> — управление переменными окружения клиента.</li>
  </ul>
  <p>Методы получают данные непосредственно из <code>backends_data</code> и возвращают результаты через D-Bus (<a href="../alterator-manager/alterator_manager_default_interfaces.c">alterator_manager_default_interfaces.c</a>).</p>
  <h2>Polkit и безопасность</h2>
  <p>Менеджер проверяет права вызова на уровне интерфейса и метода. По умолчанию action_id формируется из имени интерфейса, но может быть переопределён в backend-файле. Утилита <code>am-dev-tool</code> генерирует и валидирует policy-файлы (<a href="../alterator-manager/docs/README-ru.md">Раздел «am-dev-tool»</a>).</p>
  <p>Для удалённых подключений используется модуль <code>remote</code>, который требует парольного агента <code>org.altlinux.PasswordAgent</code> (описание в разделе «password agent» <a href="../alterator-manager/docs/README-ru.md">README</a>).</p>
  <h2>Переменные окружения отправителя</h2>
  <p>Менеджер ведёт таблицу <code>sender_environment_data</code>, где для каждого отправителя (уникальное имя D-Bus) хранится набор переменных. Значения из этой таблицы подставляются в переменные окружения методов executor. Очистка неактуальных записей выполняется раз в 10 минут таймером (<a href="../alterator-manager/docs/README-ru.md">Раздел «Переменные окружения»</a> и <a href="../alterator-manager/main.c">main.c</a>).</p>
  <h2>Мониторинг backend-файлов</h2>
  <p>Функция <code>alterator_manager_backend_monitor_backends_changed()</code> проверяет директории backends. При обнаружении изменения менеджер завершает работу, а systemd перезапускает службу (<a href="../alterator-manager/main.c">main.c</a> и <a href="../alterator-manager/alterator_manager_backend_monitor.c">alterator_manager_backend_monitor.c</a>).</p>
  <h2>Поток обработки вызова</h2>
  <ol>
    <li>Клиент вызывает метод интерфейса (например, <code>org.altlinux.alterator.service1.Deploy</code>).</li>
    <li>Менеджер ищет соответствующий <code>InterfaceObjectInfo</code> и <code>MethodObjectInfo</code> в <code>backends_data</code>.</li>
    <li>Проверяется лимит потоков и action_id для polkit (<a href="../alterator-manager/docs/README-ru.md">README</a>).</li>
    <li>Менеджер вызывает функцию модуля executor, передавая атрибуты метода (<code>execute</code>, <code>stdin_string</code>, <code>stdout_bytes</code> и др.).</li>
    <li>Результат и сигналы отправляются клиенту через D-Bus. Клиент может дополнительно подписаться на сигналы stdout/stderr.</li>
  </ol>
  <p>Понимание этого конвейера помогает отлаживать backend-файлы и писать модули. Следующая глава описывает сами модули и их формат конфигурации.</p>
</body>
</html>
