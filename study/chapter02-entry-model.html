<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Глава 2. Формат Alterator Entry и схемы</title>
</head>
<body>
  <nav><a href="index.html">На главную</a> · <a href="chapter01-overview.html">Предыдущая глава</a></nav>
  <h1>Глава 2. Формат Alterator Entry и схемы</h1>
  <p>Alterator Entry — TOML-описание сущностей Alterator. Файлы содержат метаданные об интерфейсах, сервисах, компонентах и диагностических инструментах. Спецификация описана в <a href="../alterator-entry/doc/README.md">alterator-entry/doc/README.md</a>.</p>
  <h2>Нотация и именование</h2>
  <ul>
    <li>Расширение соответствует типу: <code>.service</code>, <code>.backend</code>, <code>.object</code>, <code>.component</code> и др. (<a href="../alterator-entry/doc/README.md">Раздел «Именование файлов»</a>).</li>
    <li>Файлы системного уровня размещаются в <code>/usr/share/alterator/&lt;директория сущности&gt;</code>, пользовательские — в <code>/etc/alterator/&lt;...&gt;</code>. Карта директорий приведена в таблице раздела «Идентификатор Alterator entry» (<a href="../alterator-entry/doc/README.md">README</a>).</li>
    <li>Backend-файлы различают режимы <code>system</code> и <code>user</code>: пользовательские варианты складываются в подкаталог <code>backends/user/</code> (<a href="../alterator-entry/doc/README.md">README</a>).</li>
  </ul>
  <h2>Структура файла</h2>
  <p>Каждый Entry-файл — набор таблиц TOML:</p>
  <ul>
    <li>Корневая таблица содержит ключи <code>type</code>, <code>name</code>, <code>display_name.*</code>, <code>comment.*</code> и др. Пример <code>.service</code> показан в <a href="../alterator-test-services/test_service1/test_service1.service">alterator-test-services/test_service1/test_service1.service</a>.</li>
    <li>Комментарии начинаются с <code>#</code> и должны сохраняться при перезаписи (<a href="../alterator-entry/doc/README.md">Раздел «Комментарии»</a>).</li>
    <li>Группы объявляются квадратными скобками (<code>[group]</code>) и описывают параметры, ресурсы, методы. Ключи чувствительны к регистру (<a href="../alterator-entry/doc/README.md">Раздел «Заголовки групп»</a>).</li>
    <li>Типы значений ограничены: <code>string</code>, <code>localestring</code>, <code>iconstring</code>, <code>stringlist</code>, <code>command</code>, <code>boolean</code>, <code>numeric</code> (<a href="../alterator-entry/doc/README.md">Раздел «Возможные типы значений»</a>).</li>
  </ul>
  <h2>Специализированные секции</h2>
  <h3>Параметры сервиса</h3>
  <p>Параметры описываются блоками <code>[parameters.&lt;имя&gt;]</code>, где задаются тип, контекст, значения по умолчанию, ограничения. Образец с составными типами приведён в тестовом сервисе (<a href="../alterator-test-services/test_service1/test_service1.service">test_service1.service</a>).</p>
  <p>Для сложных объектов используется <code>type = "object"</code> и вложенная секция <code>.properties</code>. Можно включить <code>exclusive = true</code> для групп взаимоисключающих параметров (<a href="../alterator-test-services/test_service1/test_service1.service">пример group_param</a>).</p>
  <h3>Ресурсы</h3>
  <p>Секция <code>[resources.&lt;имя&gt;]</code> описывает файлы, директории, systemd-юниты и порты. Для портов задаётся <code>inet_service.value</code> и протоколы <code>tcp</code>/<code>udp</code>; допускается привязка к параметру через <code>inet_service.parameter</code> (<a href="../alterator-test-services/test_service1/test_service1.service">пример overridable_port</a>).</p>
  <h3>Diag tools и services</h3>
  <p>Сервисы могут ссылаться на диагностические инструменты через секцию <code>[diag_tools]</code> с указанием шины и пути (<a href="../alterator-test-services/test_service1/test_service1.service">пример diag_tools.tool1</a>).</p>
  <h2>JSON Schema и проверка</h2>
  <p>Каждому типу соответствует JSON Schema: <code>service.schema.json</code>, <code>backend.schema.json</code>, <code>component.schema.json</code> и др. (<a href="../alterator-entry/schemas">alterator-entry/schemas</a>). Валидация выполняется через функцию <code>validate()</code> библиотеки <a href="../alterator-entry/alterator_entry/alterator_entry.py">alterator_entry.py</a>, которая подбирает схему по полю <code>type</code> и вызывает <code>jsonschema.validate</code>.</p>
  <p>CLI-утилита <code>alterator-entry</code> поддерживает команду <code>validate</code>, обрабатывающую несколько файлов (см. <a href="../alterator-entry/scripts/alterator-entry">scripts/alterator-entry</a>). Для получения значения поля используется команда <code>alterator-entry get &lt;файл&gt; &lt;путь&gt;</code>, реализованная в функции <code>get_field()</code> (<a href="../alterator-entry/alterator_entry/alterator_entry.py">alterator_entry.py</a>).</p>
  <h2>Извлечение пакетов из изданий</h2>
  <p>Издания (<code>.edition</code>) описывают наборы компонентов и пакетов. Функция <code>extract_packages_from_edition()</code> читает секции, открывает файлы компонентов и собирает пакеты с учётом архитектуры, окружения и языка (<a href="../alterator-entry/alterator_entry/alterator_entry.py">alterator_entry.py</a>). Скрипт <a href="../alterator-entry/scripts/editions2packages">editions2packages</a> предоставляет CLI-обёртку с фильтрами по секциям, десктопам, языкам.</p>
  <h2>Практические рекомендации</h2>
  <ul>
    <li>Перед добавлением нового Entry-файла запустите <code>alterator-entry validate</code> для проверки схемы.</li>
    <li>Сохраняйте комментарии и порядок ключей: менеджер не удаляет неизвестные поля, что позволяет расширять формат без потерь (<a href="../alterator-entry/doc/README.md">README</a>).</li>
    <li>Для backend-файлов соблюдайте ограничения на имена методов и action_id: только латиница, цифры, подчёркивания/дефисы. Проверки встроены в <a href="../alterator-manager/alterator_manager_backends.c">alterator_manager_backends.c</a>.</li>
  </ul>
  <p>Понимание структуры Entry-файлов необходимо для настройки менеджера и описания новых сервисов, что рассматривается в следующей главе.</p>
</body>
</html>
