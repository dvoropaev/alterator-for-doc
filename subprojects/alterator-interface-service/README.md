
# Интерфейс org.altlinux.alterator.service1

Интерфейс service для работы с сервисами.
На данный момент все параметры необходимые для манипуляции над сервисами передаются в виде строки сразу в `stdin` процесса.


## Методы

### Info
Метод `Info () -> (Array of [Byte] stdout_bytes, Int32 response)` предназначен для предоставления информации о сервисе, представленном данным объектом, в формате [Alterator Entry - сущность `service`](https://altlinux.space/alterator/alterator-entry/src/branch/master/doc#сущность-типа-service). Результатом выполнения метода является пара массива байтов `stdout_bytes`, который содержит Alterator Entry, и `response` - код взврата.

### Status
Метод `Status () -> (Array of stdout_strings, Int32 response)` предназначен для получения текущего состояния. Возвращает:

- `response` - код возврата.
- массив байт `stdout_bytes` 

  Содержит набор активный набор [параметров](#параметры) контекста `status` (необязательно, если сервис не развёрнут). Также содержит [служебные параметры](#служебные-параметры).
 

### Deploy
Метод `Deploy (String stdin) -> (Int32 response)` предназначен для развертывания сервиса. Возвращает целое число `response` - код возврата.
Если сервис уже развёрнут, вызов этого метода завершится ошибкой.

#### Принудительное развёртывание
Для сервисов, поддерживающих данную функцию, разрешается передать [дополнительный параметр](#служебные-параметры), указывающий на необходимость пропуска некоторых проверок. Также разрешается вызов `Deploy` даже если сервис уже развёрнут.

### Start
Метод `Start () -> (Int32 response)` предназначен для запуска systemd юнитов которые использует сервис. Возвращает целое число `response` - код возврата.
Если сервис не развёрнут или уже запущен, вызов этого метода завершится ошибкой.

### Stop
Метод `Stop () -> (Int32 response)` предназначен для остановки systemd юнитов которые использует сервис. Возвращает целое число `response` - код возврата.
Если сервис не развёрнут или не запущен, вызов этого метода завершится ошибкой.

### Configure
Метод `Configure (String stdin) -> (Int32 response)` предназначен для настройки уже развёрнутого сервиса. Возвращает целое число `response` - код возврата.
Если сервис не развёрнут, вызов этого метода завершится ошибкой.

### Undeploy
Метод `Undeploy (String stdin) -> (Int32 response)` предназначен для отключения сервиса. Возвращает целое число `response` - код возврата.
Если сервис не развёрнут, вызов этого метода завершится ошибкой.

### Backup
Метод `Backup (String stdin) -> (Int32 response)` предназначен для создания резервной копии сервиса. Возвращает целое число `response` - код возврата.
Если сервис не развёрнут, вызов этого метода завершится ошибкой.

### Restore
Метод `Restore (String stdin) -> (Int32 response)` предназначен для восстановления резервной копии сервиса. Возвращает `response` - код возврата.
Если сервис не развёрнут, вызов этого метода завершится ошибкой.

## Сигналы
Следующие сигналы используются для асинхронной передачи информационных сообщений в процессе выполнения длительного действия. Следует использовать их при вызове любого из вышеописанных параметризованных методов (кроме `Status`), а также `Start` и `Stop`.
### service_stderr_signal
Сигнал `service_stderr_signal(String)` позволяет асинхронно передавать содержимое стандартного потока ошибок из экземпляра терминала, в котором выполняется процесс (развёртка,конфигурация, и т.д.), одно сообщение данного сигнала соответствует сторке из потока `stderr`.

### service_stdout_signal
Сигнал `service_stdout_signal(String)` позволяет асинхронно передавать содержимое стандартного вывода ошибок из экземпляра терминала, в котором выполняется процесс (развёртка,конфигурация, и т.д.), одно сообщение данного сигнала соответствует сторке из потока `stdout`.


## Параметры
Описание параметров изложенно в документации [Alterator Entry - сущность `service`](https://altlinux.space/alterator/alterator-entry/src/branch/master/doc#сущность-типа-service).

Каждому из параметризованных методов соответствует одноимённый контекст, по которому выбираются параметры для данного метода:
 
- Методы, изменяющие состояние сервиса (принимают параметры на вход)
  - `deploy` 
  - `configure`
  - `backup`
  - `restore`
  - `undeploy`
- Информационный метод `status` (возвращает активный набор параметров)
- контекст `diag` указывает на важность параметра для [диагностики](#диагностика).

### Константы
Параметры, являющиеся константами (см. [Alterator Entry - сущность `service`](https://altlinux.space/alterator/alterator-entry/src/branch/master/doc#сущность-типа-service)), не должны задаваться Пользователем ни в каком виде. Они также должны передаваться в методы соответствующие контексту параметра, при передаче используется [значение по умолчанию](#значения-по-умолчанию).

### Значения по умолчанию
Параметры могут иметь значения по умолчанию, которые служат в качестве подсказки для Пользователя, и могут быть переданы для развёртывания (или другого действия) без изменений. (см. [Alterator Entry - сущность `service`](https://altlinux.space/alterator/alterator-entry/src/branch/master/doc#сущность-типа-service)).
Если такой параметр имеет ещё и контекст [`status`](#status), то в таком случае результат выполнения `Status` следует считать более приоритетным источником значений по умолчанию.


### Получение и передача параметров

Передача параметров между клиентом и DBus-бэкендом сервиса осуществляется в формате JSON:

| **Тип параметра** | **Тип json-значения**       |
|:------------------|:----------------------------|
| string            | string					  |
| integer           | integer                     |
| boolean           | boolean                     |
| enum				| object                      |
| object            | object                      |
| array           	| array                    	  |

##### Параметры типа enum
Параметроы типа enum позволяют выбрать одно из именованных значений, каждое из которых может иметь некоторое количество подпараметров, подобно `object`, таким образом, в зависимости от выбранного пользователем значения, ему будет предоставлен тот или иной набор подпараметров. Преобразование в JSON формат происходит следующим образом:  

```json
"enum_parameter_name": {
  "selected_value_name": {
    // value subparameters, if defined
  }
}
```


### Служебные параметры

На текущий момент предусмотрены следующие служебные параметры:

| **Имя**  | **JSON-тип** | **Описание**        |
|:---------|:-------------|:--------------------|
| deployed | boolean      | Возвращется методом `Status` и указывает на то, развёрнут ли сервис  |
| started  | boolean      | Возвращется методом `Status` и указывает на то, запущен	ли сервис    |
| force_deploy  | boolean      | Передаётся в метод `Deploy` для [принудительного развёртывания](#принудительное-развёртывание). |


## Диагностика
Предусмотрена интеграция с [диагностическими инструментами](https://altlinux.space/alterator/alterator-interface-diag).

### Служебные переменные окружения

| **Имя**                 | **Использование** | **Описание**        |
|:------------------------|:------------------|--|
| `service_path`          | `List`, `Run` | DBus-path сервиса, для которого проводится диагностика. |
| `service_deploy_mode`   | `List`, `Run` | Режим диагностики (`pre` или `post`). |
| `service_required_only` | `List` | Получить только обязательные тесты. |

### Режимы
- Предварительная диагностика

  Проводится перед развёртыванием сервиса. Положительный результат указывает на отсутствие возможных препятствий/конфликтов для развёртывания сервиса.
  
- Пост-диагностика

  Проводится после развёртывания сервиса. Положительный результат указывает на отсутствие неполадок или ошибок в конфигурации развёрнутого сервиса.

### Списки тестов
Для получения тестов используется метод `List` интерфейса `diag1`.
Для каждого из описанных выше режимов может возвращаться разный набор тестов.
Также некоторые тесты могут быть необязательными.
Для получения полного набора (или только обязательных) тестов для того или иного режима диагностики, перед вызовом `List` следует задать описанные выше [переменные окружения](#служебные-переменные-окружения).

### Передача параметров
В отличии от описанного выше способа передачи параметров, диагностические инструменты используют переменные окружения (см. [Alterator Entry - сущность `diag`](https://altlinux.space/alterator/alterator-entry/src/branch/master/doc#сущность-типа-diag-или-diagnostictool)).
Параметры контекста `diag` сопоставляются с переменными окружения инструмента по именам.
Простые параметры типа `string`, `integer` и `boolean` передаются в виде строк, как в shell-скриптах, например `int_parameter='1'` `string_parameter='sample string'` `bool_parameter='true'`.
Сложные параметры типа `enum`, `array` и `object` также передаются в виде строк, предварительно сконвпреобразованные в JSON формат, например `object_parameter='{"a": "b", "c": true, "d": {...}'` и т.д.