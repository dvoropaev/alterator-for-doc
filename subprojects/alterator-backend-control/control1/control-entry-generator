#!/bin/bash

FACILITIES_DIR=/etc/control.d/facilities
ENTRY_PATH=/usr/share/alterator/control
GENERATED_ENTRY_PATH=/etc/alterator/control
GENERATED_BACKEND_PATH=/etc/alterator/backends
AUTOGEN_PREFIX="autogenerated-control-"
WHITELIST=/usr/lib/alterator-backend-control/whitelist
OVERRIDES=/usr/lib/alterator-backend-control/overrides
BACKEND_TEMPLATE=/usr/lib/alterator-backend-control/facility.backend.template

control() { /usr/sbin/control $@ 2>/dev/null; }

build_facility_backend(){
    local name=$1
    sed "s/<FACILITY>/$name/g; s/<FACILITY_ID>/${name//-/_}/g" < $BACKEND_TEMPLATE > $GENERATED_BACKEND_PATH/$AUTOGEN_PREFIX$name.backend
}

build_facility() {
    local name=$1
    local ignore=$2

    cat << EOF
type = "Control"
name = "$name"
display_name.en = "$name"
comment.en = '''
`control $name summary`'''

EOF

    if [[ "$ignore" == "0" ]]
    then
        for parameter in `control $name list`
        do
            cat << EOF
[states.$parameter]
display_name.en = "$parameter"
comment.en = '''
`control $name help | grep $parameter | sed "s/^$parameter\: //"`'''
type = "state"

EOF
        done
    else
        echo Facility $name is not in whitelist. Skipping states. >/dev/stderr
    fi
}


find $ENTRY_PATH -name "*.control" -type f -printf '%f\n' | sed 's/\.control$//g' | read -a existing

find $GENERATED_ENTRY_PATH   -name "$AUTOGEN_PREFIX*.control" -type f -print0 | xargs -0 rm -f '{}'
find $GENERATED_BACKEND_PATH -name "$AUTOGEN_PREFIX*.backend" -type f -print0 | xargs -0 rm -f '{}'

ls $FACILITIES_DIR | while read facility
do
    [[ " ${existing[*]} " =~ " ${facility} " ]] && continue

    ignore=1
    grep "^${facility}$" $WHITELIST >/dev/null && ignore=0

    override_entry=$OVERRIDES/$facility.control
    override_backend=$OVERRIDES/$facility.backend

    if [ -f $override_entry ]
    then
        ln $override_entry $GENERATED_ENTRY_PATH/$AUTOGEN_PREFIX$facility.control
    else
        build_facility $facility $ignore > "$GENERATED_ENTRY_PATH/$AUTOGEN_PREFIX$facility.control"
    fi

    if [ -f $override_backend ]
    then
        ln $override_backend $GENERATED_BACKEND_PATH/$AUTOGEN_PREFIX$facility.backend
    else
        build_facility_backend $facility > "$GENERATED_BACKEND_PATH/$AUTOGEN_PREFIX$facility.backend"
    fi
done
