### Назначение пакета.

### Описание.

### Формат backend файлов.

backend файлы имеют суффикс _.backend_ и хранятся в следующих директориях:
/usr/share/alterator/backends/user/ и /etc/alterator/backends/user/ - для
пользовательского режима (--user),
/usr/share/alterator/backends/, /usr/share/alterator/backends/system/ и
/etc/alterator/backends/, /etc/alterator/backends/system/ для обычного режима.
Директории названы в том порядке, в котором они обрабатываются, т.е. сначала
считываются файлы из /usr/share/alterator/backends/, затем из
/usr/share/alterator/backends/system/, затем из /etc/alterator/backends/, и
потом из /etc/alterator/backends/system/. Для пользовательского режима сначала
из /usr/share/alterator/backends/user/, потом из /etc/alterator/backends/user/.
Один backend файл описывает один интерфейс некоторого объекта. Поскольку на
одном объекте не может быть интерфейсов с одинаковыми именами, то 'дубликаты'
игнорируются при загрузке.
Данные в backend файлах хранятся в формате toml:

```
type = "Backend"
module = "executor"
name = "first2"
interface = "second"
#interface = "org.altlinux.alterator.second" //Интерфейс можно задать полным именем.
thread_limit = 5
action_id = "org.freedesktop.test"


[methods.make_ls2]
execute = "ls -al {param}"

[methods.make_ls3]
execute = "ls -al {param}"
```

Корневая таблица имеет следующие пары ключ-значение:
1. type - зависит от назначения файла. Пока заполняется словом _Backend_.
1. module - имя модуля который будет обрабатывать запросы.
1. name - имя узла (объекта) в поддереве D-Bus.
1. interface - имя интерфейса D-Bus.
1. thread_limit - максимальное число тредов для данного интерфейса.
1. action_id - action id для polkit.

Если имя интерфейса задано одной секцией (т.е. без точек, _second_ в примере
выше), то к _interface_name_ автоматически добавляется префикс
_'org.altlinux.alterator.'_. Если оно состоит из нескольких секций (разделённых
точками, например _org.altlinux.alterator.second_), то префикс не добавляется.
Пустые секции не допускаются. Каждая секция может содержать только
[A-Z][a-z][0-9]_.

Опция actiont_id не обязательная. Это actiont id для методов интерфейса
(polkit). Если actiont id не указан, то он формируется из имени интерфейса, для
чего подчёркивания заменяются на тире.

Опция thread_limit не обязательная. Если её явно не задать, то её значение
будет равно 10 (максимальное число методов выполняемых одновременно).

Методы описываются в таблице _methods_, для каждого метода отдельная подтаблица.
Имя подтаблицы - имя метода.
Имя метода может состоять только из латинских букв, цифр и символа
подчёркивания. Пробелы не допускаются.
Содержимое секции зависит от модуля который будет обрабатывать запрос.
Выше приведён пример для модуля _executor_. Поле _execute_ содержит строку для
_bash_ с исполняемым файлом. Внутри фигурных скобок могут задаваться параметры
для метода D-Bus. Параметров может не быть. Имя параметра может содержать только
латинские буквы, цифры и символ подчёркивания. В примере выше метод _make_ls2_
будет выполнять команду _ls -al_ с параметром _param_, в который можно будет
передать имя директории или файла.

Описание формата для методов других модулей будет описано здесь, либо в
документации этих модулей.

### Хранение данных.

Данные полученные от модулей и считанные из _backend_ файлов alterator-manager
хранит в хеш-таблице (backends_data). Ключами в ней являются имена узлов в
дереве D-Bus, а значениями хеш-таблицы (interfaces). Ключами в interface'ах
являются имена интерфейсов, а значениями - структуры _InterfaceObjectInfo_.
```
typedef struct {
    gchar *module_name;
    gchar *action_id;
    GDBusInterfaceInfo *interface_introspection;
    GHashTable *methods;
    const GDBusInterfaceVTable *interface_vtable;
    gint thread_limit;
} InterfaceObjectInfo;
```

module_name - имя модуля.
action_id - action id для интерфейса (для polkit).
interface_introspection - GDBusInterfaceInfo из модуля.
thread_limit - лимит тредов для интерфейса.
interface_vtable - GDBusInterfaceVTable из модуля.
methods - хеш-таблица с методами. Ключами являются имена методов ([methods.*] в
_backend_), а значениями - структуры MethodObjectInfo. В каждой такой структуре
хеш-таблица _method_data_ с информацией о методе взятой из _backend_ файла и
хеш-таблица _environment_ с информацией о переменных окружения для этого метода.
В таблице _method_data_ ключи - это ключи из таблицы описывающей метод,
а значения - это значения соответствующих ключей. Например, для _executor'а_
ключом будет _execute_, а значением - исполняемая строка.
В таблице _environment_ ключи - имена переменных окружения, значения - структуры
EnvironmentObjectInfo.


                    backends_data
        key: node_name             value: interfaces
                                            |
                                            |
                                            |
                          -------------------
                          ||
                          ||
                          \/
                      interface
        key: interface_name        value: InterfaceObjectInfo->methods
                                                                 |
                                                                 |
                                                                 |
                          ----------------------------------------
                          ||
                          ||
                          \/
                        method
        key: method_name           value: MethodObjectInfo
                                             |          |
                                             |          |
                                             |          |
                                             |          |
                         ---------------------          |
                         ||                             |
                         \/                             |
                    method_data                         -----------------------
        key: method_name           value: method_data                        ||
                                            |                                ||
                                            |                                \/
                                            |                            environment
                          -------------------                 key: env_var      value: EnvironmentObjectInfo
                          ||
                          ||
                          \/
                     method_data
    key: it depends on the module. value: it depends on the module
    For example - executor:
    key: execute                   value: executable file

### Валидация интерфейсов.

Валидация интерфейсов - это проверка соответствия интерфейса сформированного из
файла с расширением _.backend_ шаблону. Шаблон - это файл интроспекции
проверяемого интерфейса, имя этого файла состоит из имени интерфейса и
расширения _.xml_. Файлы-шаблоны лежат в /usr/share/dbus-1/interfaces.
Валидация считается не пройденной если для интерфейса существует шаблон, но не
все методы описанные в шаблоне описаны в проверяемом интерфейсе, или не
совпадают описания методов.

### Переменные окружения.

В корневом объекте, в интерфейсе org.altlinux.alterator.manager, есть методы
с помощью которых можно добавлять и удалять переменные окружения. Эти переменные
хранятся в хеш-таблице sender_environment_data, она устроена следующим образом:

                      sender_environment_data
               key: sender                value: variables
                                                     |
                                                     |
                                                     |
                                ----------------------
                                ||
                                ||
                                \/
                             variable
               key: name                  value: value

_sender_ - это уникальное имя на D-Bus (например :1.951). Пользователь
подключается к D-Bus, получает уникальное имя и добавляет переменные окружения.
В этот момент в таблице _sender_environment_data_ создаётся пара
sender->variables, где _variables_ это тоже хеш-таблица в которой и хранятся
переменные в виде пар _name_->_value_.
Эти переменные могут использоваться модулями при запуске новых процессов.
Например, если пользователь (sender) запускает новый процесс с помощью модуля
_executor_, то набор переменных окружения унаследованный этим процессом от
предка (alterator-manager) может дополниться переменными указанными в _backend_
файле в подтаблице _environment_ этого метода (см. модуль _executor_).
При этом, значения переменные получают из хеш-таблицы для этого пользователя
(sender'а) в _sender_environment_data_. Если для переменной там значения нет,
то используется значение по умолчанию из подтабицы _environment_ запускаемого
метода. Если и там для переменной значения нет, то переменная не
устанавливается.

Раз в 10 минут происходит проверка. Уникальные имена (sender'ы) которых нет
среди подключённых к D-Bus удаляются из таблицы sender_environment_data.
Удаляются и связанные с ними переменные.

### am-dev-tool.

am-dev-tool - утилита из пакета alterator-manager-tools, она предназначена для
генерации и валидации _policy_ файлов.

Пример генерации с сохранением результата в файле:
$am-dev-tool -g /usr/share/alterator/backends/file.backend -o ~/file.policy

Пример валидации:
$am-dev-tool -t /usr/share/alterator/backends/file.backend

Опция -q подавляет вывод.

### password agent.

_password agent_ - сервис используемый модулем _remote_ для аутентификации
пользователя по запросу от удалённого *polkit-agent'a* (*remote-polkit-agent*).
*bus name* сервиса указывается в параметре *agent_bus_name* метода *Connect*
модуля *remote*, т.е. для каждого соединения можно использовать отдельный агент.
У *password agent'а* должен быть объект /org/altlinux/PasswordAgent с
интерфейсом org.altlinux.PasswordAgent.

Метод __SelectUser__:
    in:
         - array of strings "users"
         - string "action_id"
         - string "message"
         - string "pty"
    out:
         - string "selected_user"
         - string "password"

*users*: список пользователей предоставленный удалённым _polkit аgent'ом_, для
аутентификации.

*action_id*: action_id действия, предоставленный удалённым *polkit аgent'ом*.

*message*: сообщение для выполняемого действия, предоставленное удалённым
*polkit аgent'ом*.

*pty*:

*selected_user*: выбранный из списка *users* пользователь.

*password*: пароль для выбранного пользователя.

Метод __ShowResult__:
    in:
         - string "result"
    out:

*result*: строка-результат возвращаемая *polkit agent'ом*.

### Модули.

## executor.

```
[methods.method_name]
execute = "ls -l {param} {param_array[]}"
stdin_string = true
stdout_strings = true
stdout_bytes = true
stdout_byte_arrays = true
stdout_string_array = true
stdout_json = ["arg1", "arg2"]
stderr_strings = true
stdout_signal_name = "stdout_signal_example"
stderr_signal_name = "stderr_signal_example"
stdout_byte_limit = 200000
stdout_strings_limit = 200000
stderr_strings_limit = 200000
thread_limit = 3
action_id = "method-name"
timeout = 60
[methods.method_name.environment.VARNAME]
default = "default value"
required = false
[methods.method_name.environment.VARNAME2]
```

Выше приведены возможные опции метода для модуля _executor_. Поле _execute_ -
обязательное, остальные - нет.
Поле _execute_ содержит строку для _bash_ с исполняемым файлом. Внутри фигурных
скобок могут задаваться параметры для метода D-Bus. Параметров может не быть.
Имя параметра может содержать только латинские буквы, цифры и символ
подчёркивания. По умолчанию тип параметра - string, но можно задавать параметры
типа "массив строк". Для этого к имени добавляются квадратные скобки (как в
примере выше). Строки из такого параметра обрамляются кавычками и используются
последовательно, одна за другой.

Поле *stdout_strings* включает возможность возврата массива строк из stdout.
Поле *stdout_bytes* включает возможность возврата массива байт из stdout.
Поле *stdout_byte_arrays* включает возврат из stdout массива байтовых массивов.
В этом случае поток байт из stdout делится по нулевым байтам на отдельные
массивы.
*stdout_string_array* тоже самое что и *stdout_byte_arrays*, но возвращаемое
значение метода не массив байтовых массивов, а массив строк.
Поле *stdout_json* включает возможность возврата нескольких строковых значений.
В этом режиме метод ожидает строку с объектом *json* из stdout процесса. Режим
включен, если данному полю присвоено значение - массив строк. Из полученного
объекта *json* извлекаются строковые элементы чьи ключи соответствуют элементам
массива. Из элементов этого массива также формируются названия возвращаемых
значений метода.

У метода может быть включен только один из вышеперечисленных режимов. Если в
описании метода указано несколько режимов, то включается тот чей приоритет
выше, а приоритет у них следующий (по возрастанию): *stdout_strings*,
*stdout_bytes*, *stdout_byte_arrays*, *stdout_string_array* и *stdout_json*.

Поля *stdout_bytes*, *stdout_byte_arrays*, *stdout_string_array* и *stdout_json*
также отключают возврат строк из stdout сигналами.

Поле stderr_strings включает возврат массива строк из потока ошибок.

Максимальный размер в байтах для соответствующего массива можно
задать с помощью полей stdout_byte_limit, stdout_strings_limit и
stderr_strings_limit. Значение по умолчанию 524288. Допустимый диапазон - от 0
до 2147483647. Работа с массивами больше 524288 не проверялась.

Вывод из _stdout_ и _stderr_ можно также получать с помощью сигналов. Имя
сигнала получается путём конкатенации sender'а (bus name) и значения
соответствующего поля (stdout_signal_name или stderr_signal_name). В sender'е
':' и '.' заменяются на '_'. Значения полей stdout_signal_name и
stderr_signal_name могут содержать только латинские буквы, цифры и символ
подчёркивания. Сигналы для stdout и stderr включены, если соответствующему полю
задано значение.

Поле *stdin_string* со значением _true_ добавляет к списку параметров метода ещё
один параметр - _stdin_. Этот параметр появляется на последнем месте в списке
параметров. Строка переданная через него отправляется в _standard input_
процесса сразу после запуска.

С помощью поля thread_limit можно задать ограничение на количество тредов для
метода, т.е. сколько экземпляров этого метода можно запустить параллельно.
Значение по умолчанию - 1.

В поле _action_id_ можно задать _action_id_ polkit для метода. Поле может
содержать только следующие символы [A-Z][a-z][0-9].-
К значению этого поля будет автоматически добавлен префикс сформированный
из имени интерфейса.

В поле _timeout_ задаётся промежуток времени по истечении которого процессу,
порождённому для выполнения данного метода, будет отправлен сигнал SIGKILL.
Время задаётся в секундах. Значение по умолчанию - 60 секунд. Если значение
поля _timeout_ ноль или меньше, то timeout не задаётся и сигнал SIGKILL не будет
отправлен. Если значение задано не корректно - timeout не задаётся и сигнал
SIGKILL не будет отправлен.

В подтаблице _environment_ перечисляются переменные окружения которые могут быть
добавлены к списку переменных окружения наследуемому от родительского процесса
(Родительский процесс - это alterator-manager. Для выполнения каждого метода
_executor_ порождает новый процесс). Каждая переменная в _environment_
описывается в отдельной таблице. Имя таблицы - это имя переменной. Строковое
поле _default_ служит для задания значения по умолчанию. Поле _required_ пока не
используется. Таблица переменной может быть пустой, тогда значение ей
присваивается через интерфейс org.altlinux.alterator.manager в корневом объекте.
Переменные не указанные в _environment_ не могут быть добавлены в окружение
процесса.


## remote.

Модуль _remote_ предназначен для подключения к удалённым машинам (лучше сказать
к удалённым alterater-manager'ам). Подключение происходит по _ssh_. remote
доступен только в режиме _--user_ и не использует _.backend_ файлы. Методы
модуля находятся в интерфейсе org.altlinux.alterator.Remote объекта
/org/altlinux/alterator/remote.

Метод __Connect__:
    in:
         - string "remote_address"
         - string "connection_name"
         - string "agent_bus_name"
         - string "pty"
    out:
         - boolean "response"
         - string "object_path"

Данный метод выполняет подключение к удалённой машине. Подключение состоит из
двух ssh соединений. Первое соединение подключается к удалённой шине d-bus с
помощью _systemd-stdio-bridge_. Второе соединение запускает на удалённой машине
специальный _polkit-agent_ - _remote-polkit-agent_, и если _polkit_ на удалённой
машине потребует подтверждения прав пользователя на выполнение действия, то этот
агент даст об этом знать модулю _remote_, а _remote_ попросит пользователя
ввести необходимые для аутентификации данные используя _password agent_.
_bus name_ _password agent'а_ задаётся параметром *agent_bus_name*.
Подробнее об этом сервисе смотрите в другом месте этого документа.

*remote_address*: адрес удалённой машины (<name>@<ip>).

*connection_name*: имя соединения может содержать только [A-Z][a-z][0-9]_. Оно
будет использовано для формирования корневого объекта поддерева отображающего
дерево объектов удалённой машины. Например, если *connection_name* - "777", то
дерево удалённой машины будет отображено в поддереве с корнем
/org/altlinux/alterator/777.

*agent_bus_name*: это *bus_name* *password agent'a* на d-bus. *password agent* -
сервис с помощью которого модуль *remote* спрашивает пароль у пользователя.
Подробнее об этом сервисе смотрите в другом месте этого документа.

*pty*:

*response*: код завершения. *TRUE* - удачное завершение метода, *FALSE* -
неудачное завершение.

*object_path*: корневой объект поддерева отображающего дерево объектов d-bus
удалённой машины. Например, если *connection_name* - "777", то должен вернуться
объект /org/altlinux/alterator/777.

Метод __Disconnect__:
    in:
         - string "connection_name"
    out:
         - boolean "response"

Этот метод выполняет отключение от удалённой машины.

*connection_name*: имя соединения. Подробности смотрите в описании метода
_Connect_.

*response*: код завершения. *TRUE* - удачное завершение метода, *FALSE* -
неудачное завершение.

Метод __GetConnections__:
    in:
    out:
         - array of strings "connections"

*connections*: список имён установленных соединений.


## backend3.

Модуль _backend3_ во многом похож на _executor_ и предназначен для использования
бэкендов из backend3 _alterator'а_. D-Bus интерфейсы использующие этот модуль
описываются в конфигурационных файлах с расширением _backend_. Один такой файл
описывает один интерфейс. Для описания используется язык TOML. Ниже приведён
пример описывающий интерфейс _org.altlinux.alterator.backend3_:

```
type = "Backend"
module = "backend3"
name = "example1"
interface = "backend3"
#interface = "org.altlinux.alterator.backend3" //Интерфейс можно задать полным именем.
action_id = "org.freedesktop.test"

[methods.method_name]
backend3 = "menu"
_objects = "avail_modules"
language = "ru_RU"
action = "list"
action_id = "test1"
```

Поле _backend3_ - обязательное, в нём указывается имя бэкенда из директории
_/usr/lib/alterator/backend3/_. Остальные поля не обязательные.
Поле _objects содержит тоже, что одноимённая переменная в бэкендах из backend3.
(Ещё можно встретить название _path_, например, в нашем случае этот path был бы
*/menu/avail_modules*, но в _objects первая часть не записывается).
В поле language указывается локаль.
В поле action указывается действие: list, write, read и прочее.
Про action_id можно почитать выше.

Методы имеют один параметр типа a{ss}, и возвращаемое значение типа aа{ss}.
В параметре передаются данные в виде пар ключ - значение. Для примера выше это
может быть {"ui":"qt", "expert_mode":"0"}.
Весь вывод метода упаковывается в тип aа{ss}.

