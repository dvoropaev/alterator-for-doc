**alterator-module-executor**\
[Русский](executor-ru.md) | [English](executor.md)

Модуль [alterator-manager'а](../README-ru.md) для запуска исполняемых файлов и
скриптов.

___

Опции метода для модуля:

```
[methods.method_name]
execute = "ls -l {param} {param_array[]}"
stdin_string = true
stdout_strings = true
stdout_bytes = true
stdout_byte_arrays = true
stdout_string_array = true
stdout_json = ["arg1", "arg2", "arg3[]"]
stderr_strings = true
stdout_signal_name = "stdout_signal_example"
stderr_signal_name = "stderr_signal_example"
stdout_byte_limit = 200000
stdout_strings_limit = 200000
stderr_strings_limit = 200000
thread_limit = 3
action_id = "method-name"
timeout = 60
[methods.method_name.environment.VARNAME]
default = "default value"
required = false
[methods.method_name.environment.VARNAME2]
```

Поле `execute` - обязательное, остальные - нет.

- Поле `execute` содержит строку для `bash` с исполняемым файлом.

  Внутри фигурных скобок могут задаваться параметры для метода D-Bus. Параметров
  может не быть. Имя параметра может содержать только латинские буквы, цифры и
  символ подчёркивания. По умолчанию тип параметра - `string`, но можно задавать
  параметры типа "массив строк". Для этого к имени добавляются квадратные скобки
  (как в примере выше). Строки из такого параметра обрамляются кавычками и
  используются последовательно, одна за другой.

- Поле `stdout_strings` включает возможность возврата массива строк из stdout.

- Поле `stdout_bytes` включает возможность возврата массива байт из stdout.

- Поле `stdout_byte_arrays` включает возврат из stdout массива байтовых
  массивов. В этом случае поток байт из stdout делится по нулевым байтам на
  отдельные массивы.

- `stdout_string_array` тоже самое что и `stdout_byte_arrays`, но возвращаемое
  значение метода не массив байтовых массивов, а массив строк.

- Поле `stdout_json` включает у метода возврат нескольких значений (типа *массив
  строк* или *строка*).

  Режим включен, если данному полю присвоено значение - массив строк.\
  В этом массиве указываются имена возвращаемых значений метода, они могут
  содержать только символы `[A-Z][a-z][0-9]_`, но для указания того, что
  возвращаемое значение имеет тип массив строк, к его имени добавляется пара
  квадратных скобок (см. пример выше), которые отбрасываются при формировании
  имени возвращаемого значения.\
  В этом режиме метод ожидает строку с объектом json из stdout процесса. Из
  этого объекта извлекаются элементы, чьи ключи соответствуют именам
  возвращаемых значений. Если извлечённый элемент имеет тип, не совпадающий с
  типом возвращаемого значения, то он заменяется пустой строкой.

> [!WARNING] У метода может быть включен только один из вышеперечисленных
> режимов. Если в описании метода указано несколько режимов, то включается тот
> чей приоритет выше, а приоритет у них следующий (по возрастанию):
> `stdout_strings`, `stdout_bytes`, `stdout_byte_arrays`, `stdout_string_array`
> и `stdout_json`.

- Поля `stdout_bytes`, `stdout_byte_arrays`, `stdout_string_array` и
  `stdout_json` также отключают возврат строк из stdout сигналами.

- Поле `stderr_strings` включает возврат массива строк из потока ошибок.

- Поля `stdout_byte_limit`, `stdout_strings_limit` и `stderr_strings_limit`
  задают максимальный размер в байтах для соответсвующего массива.

  Значение по умолчанию 524288. Допустимый диапазон - от 0 до 2147483647. Работа
  с массивами больше 524288 не проверялась.

- Вывод из stdout и stderr можно также получать с помощью сигналов. Имя сигнала
  получается путём конкатенации sender'а (bus name) и значения соответствующего
  поля (`stdout_signal_name` или `stderr_signal_name`). В sender'е `':'` и `'.'`
  заменяются на `'_'`.\
  Значения полей `stdout_signal_name` и `stderr_signal_name` могут содержать
  только латинские буквы, цифры и символ подчёркивания. Сигналы для stdout и
  stderr включены, если соответствующему полю задано значение.

- Поле `stdin_string` со значением `true` добавляет к списку параметров метода
  ещё один параметр - stdin.

  Этот параметр появляется на последнем месте в списке параметров. Строка
  переданная через него отправляется в standard input процесса сразу после
  запуска.

- С помощью поля `thread_limit` можно задать ограничение на количество тредов
  для метода, т.е. сколько экземпляров этого метода можно запустить параллельно.
  Значение по умолчанию - 1.

- В поле `action_id` можно задать action_id polkit для метода. Поле может
  содержать только следующие символы `[A-Z][a-z][0-9].-`. К значению этого поля
  будет автоматически добавлен префикс сформированный из имени интерфейса.

- В поле `timeout` задаётся промежуток времени по истечении которого процессу,
  порождённому для выполнения данного метода, будет отправлен сигнал SIGKILL.

  Время задаётся в секундах. Значение по умолчанию - 60 секунд.\
  Если значение поля `timeout` ноль или меньше, то timeout не задаётся и сигнал
  SIGKILL не будет отправлен.\
  Если значение задано не корректно - timeout не задаётся и сигнал SIGKILL не
  будет отправлен.

- В подтаблице `environment` перечисляются переменные окружения которые могут
  быть добавлены к списку переменных окружения наследуемому от родительского
  процесса (Родительский процесс - это alterator-manager. Для выполнения каждого
  метода executor порождает новый процесс).

  Каждая переменная в `environment` описывается в отдельной таблице. Имя таблицы
  \- это имя переменной. Строковое поле `default` служит для задания значения по
  умолчанию. Поле `required` пока не используется. Таблица переменной может быть
  пустой, тогда значение ей присваивается через интерфейс
  `org.altlinux.alterator.manager` в корневом объекте.\
  Переменные не указанные в `environment` не могут быть добавлены в окружение
  процесса.
