**alterator-backend-component**

[Русский](README.ru_RU.md)

Предназначен для экспонирования компонентных описаний Alterator и генерации backend-файлов на основе данных alt-components-base.

---

# Общие сведения
| Компонент | Расположение | Назначение |
| --------- | ------------ | ---------- |
| Скрипт `component` | `/usr/lib/alterator/backends/component` | Предоставляет CLI и D-Bus-методы для работы с компонентами и категориями. |
| Скрипт `generate-components-backends` | `/usr/lib/alterator/backends/component.d/generate-components-backends` | Автоматически создаёт backend-файлы `autogenerated-component-*.backend`. |
| Файлы `batch_*.backend`, `component-categories.backend` | `/etc/alterator/backends/` | Регистрируют глобальные объекты D-Bus (`batch_component_categories1`, `batch_components1`, `component_categories1`). |
| Filetrigger `alterator-backend-component.filetrigger` | `/usr/lib/rpm/filetriggers/` | Следит за установкой `.component` файлов и запускает генератор backend'ов. |

# Возможности скрипта `component`
| Подкоманда | Назначение | Особенности |
| ---------- | ---------- | ----------- |
| `list` | Перечисляет компоненты или категории. | Аргумент `--category` переключает режим. |
| `info` | Возвращает содержимое `.component` или `.category`. | Флаг `--all` собирает сведения из всех файлов, `--path` выводит путь. |
| `description` | Возвращает локализованное описание. | Ищет `description.<locale>.html` с учётом `LC_ALL`. |
| `packages` | Строит список пакетов компонента. | Требует параметры `--arch`, `--desktop`, `--language`, `--kflavour` для фильтрации. |
| `status` | Проверяет установку пакетов компонента. | В режиме `--all` запускает `rpm -q` для всего набора. |

# Генерация backend-файлов
- Filetrigger отслеживает появление файлов `.component` в каталоге `/usr/share/alterator/components`.
- При изменениях вызывается `generate-components-backends`, который очищает старые `autogenerated-component-*.backend` и создаёт новые описания.
- Каждый backend использует `executor` для методов `Info`, `Description`, `Status`, передавая вызовы в скрипт `component`.
- Созданные файлы обеспечивают появление объектов `/org/altlinux/alterator/<component_name>` в `alterator-manager`.

# Работа с пакетами компонентов
- Фильтрация пакетов учитывает поля `arch`, `exclude_arch`, `desktop`, `language`, `kernel_module` из TOML.
- Результат `packages` выводится построчно в TTY либо в одну строку для конвейеров.
- Команда `status --all` собирает данные обо всех пакетах, запускает `rpm -q`, объединяет stderr и добавляет отфильтрованные элементы.
- При вызове `status <name>` утилита проверяет поставщиков пакетов через `rpm -q --whatprovides` и возвращает код `1`, если списки пусты или есть ошибки.

# Проверка корректности
1. Поместить тестовый `.component` в `/usr/share/alterator/components/<name>/<name>.component`.
2. Запустить `generate-components-backends` и убедиться в появлении `autogenerated-component-<name>.backend`.
3. Выполнить `component info <name>` и `component status <name>` для проверки содержимого и установки пакетов.
4. Для D-Bus проверить наличие объектов `org.altlinux.alterator.component1` через `busctl tree org.altlinux.alterator`.

# Документация по интерфейсам
- `batch_component_categories1` — передаёт клиенту Alterator содержимое всех файлов `.category` одним запросом. См. [batch_component_categories1.md](./batch_component_categories1.md).
- `batch_components1` — выдаёт сведения обо всех компонентах и их статусе установки. См. [batch_components1.md](./batch_components1.md).
- `component_categories1` — обеспечивает чтение, описание и перечисление категорий компонентов. См. [component_categories1.md](./component_categories1.md).
